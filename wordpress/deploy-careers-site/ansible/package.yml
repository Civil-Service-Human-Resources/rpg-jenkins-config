# Given a release branch identifier, grab the contents and create a
# release package.
# TODO:
# Feed in the git release branch identifier
# Copy the result to bintray?
# rename the zip appropriately
# add details to release txt
---
- hosts: localhost
  vars:
    git_repo: git@github.com:Civil-Service-Human-Resources/rpg-careers-wp.git
    git_branch: release
    package_dest: ./deployment
    package_src: ./source
    package_folders:
    - mu-plugins
    - themes
    - plugins
    - sql

    path_wp_content: "{{package_dest}}/wp-content"
    path_mu_plugins: "{{path_wp_content}}/mu-plugins"
    path_plugins: "{{path_wp_content}}/plugins"
    path_themes: "{{path_wp_content}}/themes"
    path_sql: "{{path_wp_content}}/sql"

  tasks:

  - name: create the source directory
    file:
      path: "{{package_src}}"
      state: directory
      mode: 0755

  - name: create the deployment directory
    file:
      path: "{{package_dest}}/wp-content/{{item}}"
      state: directory
      mode: 0755
    with_items: "{{package_folders}}"

  - name: create a release note file
    file:
      path: "{{package_dest}}/release_note.txt"
      state: touch

  - name: checkout the release branch
    git:
      repo: "git@github.com:Civil-Service-Human-Resources/rpg-careers-wp.git"
      dest: "{{package_src}}"
      version: "{{git_branch}}"

  - name: move mu-plugins to package
    copy:
      src: "{{item}}"
      dest: "{{path_mu_plugins}}"
    with_fileglob:
    - "{{package_src}}/mu-plugins/*.php"

  - name: create forked plugins directories in package plugins directory
    file:
      path: "{{path_plugins}}/{{item.path}}"
      state: directory
    with_filetree:
    - "{{package_src}}/third-party-plugins-forked/"
    when: item.state == 'directory'
    no_log: true

  - name: copy forked plugin files to package directory
    copy:
      src: "{{item.src}}"
      dest: "{{path_plugins}}/{{item.path}}"
    with_filetree:
    - "{{package_src}}/third-party-plugins-forked/"
    when: item.state == 'file'
    no_log: true

  - name: create standard plugins directories in package plugins directory
    file:
      path: "{{path_plugins}}/{{item.path}}"
      state: directory
    with_filetree:
    - "{{package_src}}/third-party-plugins/"
    when: item.state == 'directory'
    no_log: true

  - name: copy plugin files to package directory
    copy:
      src: "{{item.src}}"
      dest: "{{path_plugins}}/{{item.path}}"
    with_filetree:
    - "{{package_src}}/third-party-plugins/"
    when: item.state == 'file'
    no_log: true

  - name: create themes directory in package
    file:
      path: "{{path_themes}}/{{item.path}}"
      state: directory
    with_filetree:
    - "{{package_src}}/theme/"
    when: item.state == 'directory'
    no_log: true

  - name: copy theme directory to package
    copy:
      src: "{{item.src}}"
      dest: "{{path_themes}}/{{item.path}}"
    with_filetree:
    - "{{package_src}}/theme/"
    when: item.state == 'file'
    no_log: true

  - name: copy wp-config to root of package
    copy:
      src: "{{package_src}}/wp-config/wp-config.php"
      dest: "{{package_dest}}/"

  - name: create a zip
    archive:
      path: "{{package_dest}}/"
      dest: "./release.zip"
      format: zip
