# post deployment script reimports the DB and 
# places in uploads folder inplace

---

- include: prompts.yml

- hosts: localhost
  vars:
    base_dir: .
    git_branch: release

  tasks:

  - name: set fact for base dir
    set_fact:
      base_dir: "{{base_dir}}"
  
  - name: set fact for branch
    set_fact:
      git_branch: "{{git_branch}}"
      
  
  - name: Get the environment details
    ec2_instance_facts:
      filters:
        "tag:Name": "{{env}}-efs-connector-stack"
        "tag:Environment": "{{env}}"
    register: ec2_remote_facts_output
    tags:
    - setup
    - search

  - name: Debug the ec2_remote_facts
    debug:
      msg: "{{env}}: {{ec2_remote_facts_output.instances[0].public_ip_address}}"
    tags:
    - setup
    - search

  - name: Register the host
    add_host:
      hostname: "{{ec2_remote_facts_output.instances[0].public_ip_address}}"
      groupname: efs_hosts
    tags:
    - setup
    - search

  - name: get the one time file and put in remote plugins directory
    get_url:
      url: "https://github.com/Civil-Service-Human-Resources/rpg-careers-wp/blob/{{git_branch}}/mu-plugins/rpg-one-time.php"
      dest: "{{base_dir}}/download/rpg-one-time.php"
      mode: 0755

  - name: stop wordpress service
    shell: |
      aws ecs update-service --cluster {{env}}-cshr-ecs-cluster \
      --service {{env}}-careers-site \
      --desired-count 0
    tags:
    - stop-ecs

- hosts: efs_hosts
  vars:
    sql_directory: /data/db-scripts/post-deploy
    sql_files:
    - post-deploy-rpg-careers-baseline-build.sql
    - post-deploy-users.sql
    uploads_directory: /data/wp-content/uploads
    mu_plugins_directory: /data/wp-content/mu-plugins
    site_url: careers-site.{{env}}.cshr-gov.uk
    base_dir: "{{hostvars['localhost']['base_dir']}}"
    git_branch: "{{hostvars['localhost']['git_branch']}}"

  tasks:

  - name: make a directory for post install files
    file:
      path: "{{sql_directory}}"
      state: directory
      mode: 0777
    become: true

  - name: copy the sql files to the host
    copy:
      src: "{{base_dir}}/static/sql/{{item}}"
      dest: "{{sql_directory}}/{{item}}"
    with_items: "{{sql_files}}"

  - name: replace the URL in the sql file with 
    replace:
      path: "{{sql_directory}}/post-deploy-rpg-careers-baseline-build.sql"
      regexp: 'CAREERS-SITE.URL'
      replace: '{{site_url}}'
    
  - name: run the sql files
    shell: mysql -u {{db_user}} --password={{db_password}} -h careers-site-db.{{env}}.cshr-gov.uk --database wordpress < {{sql_directory}}/{{item}} 2>&1 > {{sql_directory}}/{{item}}.log 
    with_items: "{{sql_files}}"

  - name: make sure the uploads folder exists
    file:
      path: "{{uploads_directory}}"
      state: directory
      mode: 0777

  - name: unzip the uploads folder
    unarchive:
      src: "{{base_dir}}/static/files/uploads.zip"
      dest: "{{uploads_directory}}"
      mode: 0775

  - name: copy the mu plugins file to remote
    copy:
      src: "{{base_dir}}/download/rpg-one-time.php"
      dest: "{{mu_plugins_directory}}/rpg-one-time.php"
      mode: 0755



- hosts: localhost
  tasks:

  - name: restart wordpress
    shell: |
      aws ecs update-service --cluster {{env}}-cshr-ecs-cluster \
      --service {{env}}-careers-site \
      --desired-count 1
    tags:
    - start-ecs
  


  

